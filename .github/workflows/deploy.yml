name: Deployment Pipeline

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_IMAGE_NAME: heart-disease-api
  DOCKER_IMAGE_TAG: latest

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact from workflow run
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci-cd.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: docker-image
          path: ./
          if_no_artifact_found: ignore

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if Docker image artifact exists
        id: check_artifact
        if: github.event_name == 'workflow_run'
        run: |
          if [ -f docker-image.tar.gz ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Load Docker image
        if: github.event_name == 'workflow_run' && steps.check_artifact.outputs.exists == 'true'
        run: |
          gunzip -c docker-image.tar.gz | docker load
          echo "Docker image loaded successfully"

      - name: Build Docker image (if artifact not available)
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && steps.check_artifact.outputs.exists == 'false')
        run: |
          echo "Building Docker image from source..."
          # Note: For manual dispatch, you may need to download model artifacts first
          # or ensure they exist in the repository
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} -f docker/Dockerfile .

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Validate Kubernetes manifests
        run: |
          echo "Validating Kubernetes deployment manifests..."
          # This would require kubectl and a kubeconfig
          # For now, we'll just validate the YAML syntax
          if command -v kubectl &> /dev/null; then
            kubectl apply --dry-run=client -f k8s/deployment.yaml || echo "kubectl not configured, skipping validation"
          else
            echo "kubectl not available, skipping validation"
          fi

      - name: Validate Helm chart
        run: |
          echo "Validating Helm chart..."
          if command -v helm &> /dev/null; then
            helm lint k8s/helm/ || echo "Helm not configured, skipping validation"
          else
            echo "Helm not available, skipping validation"
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Kubernetes manifests validated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Helm chart validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Actual deployment requires kubectl configuration and cluster access." >> $GITHUB_STEP_SUMMARY

